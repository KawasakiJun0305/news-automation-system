# システム設計書 - System Design Document

## 📋 ドキュメント情報

```
プロジェクト名：Digest Daily
バージョン：1.0
作成日：2026-01-29
対象：要件定義書 v1.0 に基づく設計
```

---

## 1️⃣ システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    外部ニュースソース                         │
├──────────┬──────────┬──────────┬──────────┬─────────┐
│ NewsAPI  │ RSS      │ EDINET   │ arXiv    │ 将来追加  │
└──────────┴──────────┴──────────┴──────────┴─────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
        ┌────────────────────▼────────────────────┐
        │   【データ取得層】Data Fetcher         │
        │  - 複数ソース並列取得                  │
        │  - レート制限管理                      │
        │  - エラーハンドリング                  │
        └────────────────────┬────────────────────┘
                             │
        ┌────────────────────▼────────────────────┐
        │   【処理層】Processing Layer           │
        │  ┌─────────────────────────────────┐  │
        │  │ 1. データ正規化                  │  │
        │  │    複数ソース → 統一スキーマ    │  │
        │  │ 2. フィルタリング                │  │
        │  │    低品質記事を除外              │  │
        │  │ 3. スコアリング                  │  │
        │  │    重要度を 0-100 で数値化      │  │
        │  │ 4. 要約生成                      │  │
        │  │    Claude/ChatGPT/Gemini で     │  │
        │  │ 5. キーワード抽出                │  │
        │  │ 6. 重複排除                      │  │
        │  │ 7. ランキング                    │  │
        │  └─────────────────────────────────┘  │
        └────────────────────┬────────────────────┘
                             │
        ┌────────────────────▼────────────────────┐
        │   【LLM 層】LLM Routing Layer          │
        │  - Claude（高精度）                    │
        │  - ChatGPT（バランス）                 │
        │  - Gemini（低コスト）                  │
        │  自動ルーティング                      │
        └────────────────────┬────────────────────┘
                             │
        ┌────────────────────▼────────────────────┐
        │   【出力層】Output Layer               │
        │  ├─ HTML（新聞風）→ GitHub Pages    │
        │  ├─ Markdown → Git 管理              │
        │  ├─ Notion → データベース           │
        │  └─ Note（将来）                     │
        └────────────────────┬────────────────────┘
                             │
        ┌────────────────────▼────────────────────┐
        │   【配信】                             │
        │  - iPad Safari で毎朝閲覧              │
        │  - GitHub Pages で公開                 │
        │  - Notion で共有                       │
        └────────────────────────────────────────┘

【実行環境】
  GitHub Actions
  毎朝 6 時に自動実行
```

---

## 2️⃣ レイヤー設計

### 2.1 Data Access Layer（データアクセス層）

```python
# src/data_sources/

【責務】
- 複数ニュースソースからデータを取得
- レート制限を守る
- エラーが起きても他のソースは継続
- 取得したデータを正規化前のまま保持

【主要クラス】
- BaseSource（抽象基底クラス）
- NewsAPISource
- RSSSource
- EDINETSource
- ArxivSource
```

### 2.2 Business Logic Layer（業務ロジック層）

```python
# src/core/

【責務】
- データ正規化
- フィルタリング・スコアリング
- 重複排除・ランキング
- キャッシング管理

【主要クラス】
- DataNormalizer
- ArticleFilter
- ArticleScorer
- Deduplicator
- Ranker
- CacheManager
```

### 2.3 LLM Layer（言語モデル層）

```python
# src/llm/

【責務】
- Claude/ChatGPT/Gemini との連携
- カテゴリ別に最適な API を自動選択
- 要約生成・キーワード抽出
- フェイルオーバー機構

【主要クラス】
- BaseClient（抽象基底クラス）
- ClaudeClient
- OpenAIClient
- GeminiClient
- AdaptiveLLMRouter
```

### 2.4 Output Layer（出力層）

```python
# src/outputs/

【責務】
- 記事データを複数形式に変換
- HTML・Markdown・Notion フォーマット
- 出力ファイル生成・API 連携

【主要クラス】
- HTMLGenerator
- MarkdownGenerator
- NotionUploader
- (将来) NoteFormatter
```

---

## 3️⃣ クラス図

```
UniversalArticle
├─ id: str
├─ title: str
├─ source_url: str
├─ source_name: str
├─ published_at: datetime
├─ summary: str (optional)
├─ keywords: List[str] (optional)
├─ relevance_score: int (optional)
└─ original_data: dict

DataFetcher
├─ sources: Dict[str, BaseSource]
├─ fetch_all() → List[UniversalArticle]
└─ _fetch_with_rate_limit()

ArticleScorer
├─ SCORING_WEIGHTS
├─ calculate_score() → int
└─ _assess_difficulty() → str

AdaptiveLLMRouter
├─ routing_config
├─ select_provider() → str
└─ summarize_with_fallback()

HTMLGenerator
├─ HTML_TEMPLATE
├─ generate() → str
└─ _format_article()
```

---

## 4️⃣ データフロー図（DFD）

### 4.1 レベル 0（全体図）

```
【入力】
複数ニュースソース

    │
    ▼

【処理】
Digest Daily システム
（取得 → 処理 → 出力）

    │
    ▼

【出力】
HTML / Markdown / Notion
```

### 4.2 レベル 1（詳細）

```
【1. データ取得】
  NewsAPI ─┐
  RSS ──────┼─→ DataFetcher ──┐
  EDINET ──┤                 │
  arXiv ───┘                 │
                              │
  【2. 正規化】               │
  ←─ DataNormalizer ←────────┘
                │
                ▼
  UniversalArticle (統一形式)
                │
                ├─→ ArticleFilter ──→ フィルタリング済み
                │
                ├─→ ArticleScorer ──→ スコア計算
                │
                ├─→ AdaptiveLLMRouter ──→ 要約生成
                │   ├─ Claude
                │   ├─ ChatGPT
                │   └─ Gemini
                │
                ├─→ KeywordExtractor ──→ キーワード抽出
                │
                ├─→ Deduplicator ──→ 重複排除
                │
                ├─→ Ranker ──→ ランキング
                │
                ▼
  処理済み記事（最終版）
                │
                ├─→ HTMLGenerator ──→ HTML ファイル
                │
                ├─→ MarkdownGenerator ──→ Markdown ファイル
                │
                └─→ NotionUploader ──→ Notion API
```

---

## 5️⃣ インターフェース設計

### 5.1 API インターフェース

#### **データフェッチャー API**

```python
class DataFetcher:
    async def fetch_all() -> List[UniversalArticle]:
        """
        全ソースから記事を取得（非同期）
        """

    async def fetch_by_source(source_name: str) -> List[UniversalArticle]:
        """
        特定ソースから記事を取得
        """
```

#### **スコアラー API**

```python
class ArticleScorer:
    def calculate_score(
        article: UniversalArticle,
        keywords_matched: List[str]
    ) -> int:
        """
        記事のスコア（0-100）を計算
        """
```

#### **LLM ルーター API**

```python
class AdaptiveLLMRouter:
    async def summarize(
        article: UniversalArticle,
        category: str
    ) -> Tuple[str, str]:
        """
        記事を要約（最適な API で自動実行）
        戻り値：(要約, 使用した API)
        """
```

### 5.2 ファイルインターフェース

#### **入出力ファイル形式**

```
【入力】
- .env（API キー）
- config.py（設定）

【出力】
- news/YYYY-MM-DD.html（HTML）
- news/YYYY-MM-DD.md（Markdown）
- articles_archive.csv（履歴）
```

---

## 6️⃣ セキュリティ設計

### 6.1 認証・認可

```
【API キー管理】
- 本番環境：GitHub Secrets で管理
- 開発環境：.env で管理（Git に含めない）
- 呼び出し：環境変数から読み込み

【アクセス制御】
- GitHub リポジトリ：Private（セキュリティ上）
- GitHub Pages：Public（表示用）
- Notion：API トークンで制限
```

### 6.2 データ保護

```
【個人情報】
- API キー：暗号化・安全に保管
- ユーザーデータ：含まない（個人用のため）
- ログ：機密情報を含まない

【通信セキュリティ】
- 全 API：HTTPS のみ
- Git：SSH キーで認証（推奨）
```

### 6.3 入力検証

```
【バリデーション】
- API レスポンス：形式チェック
- 記事データ：タイトル・URL の存在確認
- スコア：0-100 の範囲チェック
```

---

## 7️⃣ エラーハンドリング設計

```python
【エラー処理戦略】

1. 記事取得エラー
   try:
       articles = fetch_from_source()
   except SourceDownError:
       log_error()
       # 他のソースは継続
       continue

2. API 呼び出しエラー
   try:
       summary = await claude.summarize()
   except RateLimitError:
       use_cache()  # キャッシュから返す
   except:
       use_fallback_api()  # 別の API で試す

3. ファイル出力エラー
   try:
       write_html_file()
   except IOError:
       log_error()
       # システムは停止（致命的エラー）
       raise
```

---

## 8️⃣ 性能設計

### 8.1 処理時間目標

```
【全体】
- 取得：3-5 分
- 処理：5-8 分
- 出力：2-3 分
- 合計：10-15 分以内

【各処理】
- データ正規化：< 1 分
- スコアリング：< 2 分
- LLM 呼び出し：< 5 分（ボトルネック）
- HTML 生成：< 1 分
```

### 8.2 最適化方針

```
【並列処理】
- 複数ソースの取得：asyncio で並列化
- LLM 呼び出し：バッチ処理で効率化

【キャッシング】
- 同じ記事の重複処理を避ける
- 過去 24 時間のデータを保持

【軽量化】
- 古い記事（72 時間以上）は取得しない
- 短すぎる記事（< 50 文字）は除外
```

---

## 9️⃣ スケーラビリティ設計

```
【将来の拡張】
- 記事数：1,000 → 10,000 件/日 対応可能
- ソース数：5 → 20+ 対応可能
- ユーザー数：1 → 複数ユーザー対応可能

【実現方法】
- データベース化（SQLite → PostgreSQL）
- キャッシング強化
- API バッチ処理
- マイクロサービス化（将来）
```

---

## 🔟 リスク軽減設計

| リスク | 軽減対策 |
|--------|---------|
| API レート制限 | キャッシング、遅延実行 |
| API 障害 | フェイルオーバー、別 API |
| GitHub Actions 障害 | 通知システム（将来） |
| ストレージ不足 | 古いデータの自動削除 |
| キー漏洩 | Secrets 管理、.gitignore |

---

**このシステム設計に基づいて、実装を進めます！**
