# テスト計画書 - Test Plan Document

## 📋 ドキュメント情報

```
プロジェクト名：Digest Daily
バージョン：1.0
作成日：2026-01-29
対象：フェーズ 1-6（MVP）
```

---

## 1️⃣ テスト方針

### 1.1 テスト目標

```
✅ 各機能が要件定義書に従って正しく動作すること
✅ エラーが起きても他の機能は継続すること
✅ パフォーマンスが目標値内であること
✅ セキュリティが確保されていること
```

### 1.2 テストアプローチ

```
【テスト階層】
1. ユニットテスト（関数単位）
2. 統合テスト（複数モジュール）
3. システムテスト（全体）
4. 本番環境テスト（GitHub Actions）

【テスト手法】
- ホワイトボックステスト（コード見える）
- ブラックボックステスト（入出力のみ）
- 境界値テスト（エッジケース）
```

---

## 2️⃣ テストケース

### 2.1 ユニットテスト

#### **UT-1：NewsAPI 記事取得**

| ID | テスト項目 | 入力 | 期待値 | 実施時期 |
|----|----------|------|--------|---------|
| UT-1-1 | 正常系：記事取得成功 | キーワード："AI" | 記事リスト取得 | フェーズ 2 |
| UT-1-2 | 異常系：API エラー | 無効なキー | エラー処理＆ログ出力 | フェーズ 2 |
| UT-1-3 | 異常系：タイムアウト | 極端に長い待機 | リトライ＆キャッシュから返す | フェーズ 2 |
| UT-1-4 | 境界値：0 件取得 | 存在しないキーワード | 空リスト返却 | フェーズ 2 |

#### **UT-2：データ正規化**

| ID | テスト項目 | 入力 | 期待値 | 実施時期 |
|----|----------|------|--------|---------|
| UT-2-1 | NewsAPI → UniversalArticle | NewsAPI レスポンス | 統一スキーマに変換 | フェーズ 2 |
| UT-2-2 | RSS → UniversalArticle | RSS エントリ | 統一スキーマに変換 | フェーズ 7 |
| UT-2-3 | スキーマバリデーション | 不正なデータ | バリデーション失敗 | フェーズ 2 |

#### **UT-3：スコアリング**

| ID | テスト項目 | 入力 | 期待値 | 実施時期 |
|----|----------|------|--------|---------|
| UT-3-1 | 正常系：スコア計算 | 記事データ | 0-100 のスコア | フェーズ 4 |
| UT-3-2 | 高スコア：キーワード含む | AI + TechCrunch | スコア > 70 | フェーズ 4 |
| UT-3-3 | 低スコア：古い記事 | 公開日：72 時間前 | スコア < 30 | フェーズ 4 |
| UT-3-4 | 境界値：スコア 0-100 | 各種条件組み合わせ | 常に 0-100 範囲 | フェーズ 4 |

#### **UT-4：Claude 要約生成**

| ID | テスト項目 | 入力 | 期待値 | 実施時期 |
|----|----------|------|--------|---------|
| UT-4-1 | 正常系：要約生成 | ニュース記事 | 日本語 2-3 文 | フェーズ 3 |
| UT-4-2 | 精度テスト：日本語 | 日本語記事 | 自然な日本語 | フェーズ 3 |
| UT-4-3 | エラーハンドリング | API キー無効 | エラーメッセージ出力 | フェーズ 3 |
| UT-4-4 | トークン制限 | 長すぎるテキスト | 制限内で処理 | フェーズ 3 |

#### **UT-5：HTML 生成**

| ID | テスト項目 | 入力 | 期待値 | 実施時期 |
|----|----------|------|--------|---------|
| UT-5-1 | HTML 構文 | 記事リスト | 有効な HTML5 | フェーズ 5 |
| UT-5-2 | ブラウザ表示 | 生成 HTML | Safari で正常表示 | フェーズ 5 |
| UT-5-3 | レスポンシブ | iPad 画面（1024px） | 見やすいレイアウト | フェーズ 5 |
| UT-5-4 | 文字化け対応 | 日本語を含む記事 | 正しく表示 | フェーズ 5 |

### 2.2 統合テスト

#### **IT-1：全フロー統合**

| ID | テストシナリオ | 実施内容 | 成功条件 | 実施時期 |
|----|-------------|--------|---------|---------|
| IT-1-1 | ニュース取得～出力 | NewsAPI → 正規化 → スコアリング → HTML | 新聞風 HTML が生成される | フェーズ 6 |
| IT-1-2 | 複数ソース同時実行 | NewsAPI + RSS 同時取得 | 全ソースから記事が取得される | フェーズ 7 |
| IT-1-3 | エラーハンドリング | NewsAPI 失敗時 | 他のソースは継続 | フェーズ 6 |
| IT-1-4 | キャッシング動作 | 同じ記事を連続取得 | 2 回目はキャッシュから返す | フェーズ 2 |

#### **IT-2：API ルーティング**

| ID | テストシナリオ | 入力 | 期待値 | 実施時期 |
|----|-------------|------|--------|---------|
| IT-2-1 | カテゴリ別 API 選択 | AI カテゴリ | Claude 使用 | フェーズ 3 |
| IT-2-2 | フェイルオーバー | Claude エラー | OpenAI で実行 | フェーズ 3 |
| IT-2-3 | コスト最適化 | 簡単な記事 | Gemini 使用 | フェーズ 3 |

### 2.3 システムテスト

#### **ST-1：本番環境テスト**

| ID | テストシナリオ | 実施方法 | 成功条件 | 実施時期 |
|----|-------------|--------|---------|---------|
| ST-1-1 | GitHub Actions 実行 | 手動トリガー | 正常に完了 | フェーズ 6 |
| ST-1-2 | 毎日自動実行 | 3 日連続実行 | 毎日 6 時に実行される | フェーズ 6 |
| ST-1-3 | GitHub Pages 配置 | デプロイ確認 | URL から HTML 閲覧可能 | フェーズ 6 |
| ST-1-4 | iPad 表示 | Safari で閲覧 | 見やすいレイアウト | フェーズ 6 |
| ST-1-5 | Notion 投稿 | 記事が投稿される | データベースに記録 | フェーズ 5 |

---

## 3️⃣ テスト実行手順

### 3.1 ユニットテスト実行

```bash
# 全テスト実行
pytest tests/ -v

# 特定テストファイルのみ実行
pytest tests/test_newsapi_source.py -v

# テストカバレッジ確認
pytest tests/ --cov=src --cov-report=html

# 出力：htmlcov/index.html をブラウザで開く
```

### 3.2 統合テスト実行

```bash
# 統合テストのみ実行
pytest tests/test_integration.py -v

# 統合テスト + 性能テスト
pytest tests/test_integration.py -v --durations=10
```

### 3.3 本番環境テスト

```bash
# GitHub から最新コード pull
git pull origin main

# 手動で main.py 実行（GitHub Actions をシミュレート）
python src/main.py

# 出力ファイル確認
ls -la news/$(date +%Y-%m-%d).*

# GitHub Pages で確認
# https://YOUR_USERNAME.github.io/digest-daily/
```

---

## 4️⃣ テストデータ

### 4.1 テスト記事データ

```python
# tests/fixtures/sample_data.json

SAMPLE_ARTICLES = [
    {
        "title": "OpenAI が GPT-5 を発表",
        "content": "OpenAI は本日、次世代言語モデル GPT-5 をプレビュー公開しました...",
        "url": "https://example.com/article1",
        "source": "TechCrunch",
        "publishedAt": "2026-01-29T08:00:00Z"
    },
    ...
]

EDGE_CASES = [
    { "title": "", "content": "No title" },  # 空タイトル
    { "title": "A", "content": "Very short" },  # 短いタイトル
    { "title": "古い記事", "content": "...", "publishedAt": "2025-01-01T00:00:00Z" },  # 古い記事
]
```

### 4.2 モックデータ

```python
# API レスポンスをモック化
from unittest.mock import patch

@patch('requests.get')
def test_newsapi_with_mock(mock_get):
    mock_get.return_value.json.return_value = {
        "articles": [
            {"title": "Test Article", "url": "https://example.com"}
        ]
    }
    # テスト実行
```

---

## 5️⃣ テスト結果管理

### 5.1 テスト報告フォーマット

```markdown
# テスト実行報告書

**実行日**：2026-01-29
**実行者**：Jun
**対象**：フェーズ 2

## テスト結果サマリー

| カテゴリ | 成功 | 失敗 | スキップ |
|--------|------|------|---------|
| ユニットテスト | 25 | 0 | 0 |
| 統合テスト | 5 | 0 | 0 |
| **合計** | **30** | **0** | **0** |

**テストカバレッジ**：85%

## 検出された問題

### バグ #1：NewsAPI タイムアウト
- **重要度**：高
- **再現手順**：ネットワーク遅い環境で実行
- **対応策**：リトライロジック追加

## 次回対応予定

- [ ] バグ #1 対応
- [ ] テストケース追加
```

---

## 6️⃣ テストチェックリスト

### フェーズごとのテスト実施チェック

#### **フェーズ 2：データ取得**
- [ ] NewsAPI 接続テスト成功
- [ ] 記事取得テスト成功
- [ ] 正規化テスト成功
- [ ] テストコード実装完了
- [ ] カバレッジ > 80%

#### **フェーズ 3：LLM 処理**
- [ ] Claude API 接続テスト成功
- [ ] 要約生成テスト成功
- [ ] API ルーター動作確認
- [ ] フェイルオーバーテスト成功
- [ ] テストカバレッジ > 80%

#### **フェーズ 4：記事ロジック**
- [ ] フィルタリングテスト成功
- [ ] スコアリングテスト成功
- [ ] キーワード抽出テスト成功
- [ ] 重複排除テスト成功
- [ ] ランキングテスト成功

#### **フェーズ 5：出力機能**
- [ ] HTML 生成テスト成功
- [ ] Markdown 生成テスト成功
- [ ] Notion 投稿テスト成功
- [ ] ブラウザ表示確認

#### **フェーズ 6：GitHub 連携**
- [ ] GitHub Actions 実行成功
- [ ] 毎朝自動実行確認
- [ ] GitHub Pages デプロイ成功
- [ ] iPad 表示確認
- [ ] 統合テスト成功

---

## 7️⃣ 回帰テスト計画

```
新機能追加時に、既存機能が壊れていないか確認

【回帰テスト項目】
- NewsAPI 取得機能
- スコアリング機能
- HTML 生成機能
- GitHub Actions 自動実行

【実行頻度】
- 新機能追加後は毎回実行
- 本番環境反映前は必須
```

---

## 8️⃣ パフォーマンステスト

```
【性能目標】
- 全処理：< 15 分
- API 呼び出し：< 5 分
- HTML 生成：< 2 秒
- メモリ使用量：< 500MB

【計測方法】
import time
start = time.time()
process_articles()
elapsed = time.time() - start
print(f"処理時間：{elapsed:.2f} 秒")
```

---

**テスト実装は各フェーズで実施します！**
